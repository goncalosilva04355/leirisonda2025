<!doctype html>
<html lang="pt">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Teste Diagn√≥stico Firebase - Leirisonda</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background: #f5f5f5;
      }
      .container {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .status {
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
      }
      .success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .warning {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
      }
      .info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }
      button {
        padding: 10px 20px;
        margin: 5px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      button:hover {
        background: #0056b3;
      }
      button:disabled {
        background: #6c757d;
        cursor: not-allowed;
      }
      .log {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        padding: 15px;
        border-radius: 4px;
        margin: 10px 0;
        max-height: 300px;
        overflow-y: auto;
        font-family: monospace;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üîç Diagn√≥stico Firebase - Problema de Escrita</h1>
      <p>
        Esta p√°gina testa especificamente o problema:
        <strong>"Firebase operacional mas n√£o grava dados"</strong>
      </p>

      <div id="status" class="status info">
        ‚è≥ Pronto para testar. Clique em "Executar Diagn√≥stico" para come√ßar.
      </div>

      <div style="margin: 20px 0">
        <button onclick="runQuickTest()" id="quickBtn">üöÄ Teste R√°pido</button>
        <button onclick="runFullDiagnostic()" id="fullBtn">
          üîç Diagn√≥stico Completo
        </button>
        <button onclick="testWriteOperations()" id="writeBtn">
          ‚úèÔ∏è Testar Escrita
        </button>
        <button onclick="checkFirebaseRules()" id="rulesBtn">
          üîí Verificar Regras
        </button>
        <button onclick="clearLog()" id="clearBtn">üßπ Limpar Log</button>
      </div>

      <div id="log" class="log"></div>

      <div style="margin-top: 20px">
        <h3>‚ÑπÔ∏è Problemas Comuns e Solu√ß√µes</h3>
        <ul>
          <li>
            <strong>Permission Denied:</strong> Regras do Firestore muito
            restritivas
          </li>
          <li>
            <strong>Unauthenticated:</strong> Usu√°rio n√£o est√° logado no
            Firebase Auth
          </li>
          <li><strong>Network Error:</strong> Problemas de conectividade</li>
          <li>
            <strong>Quota Exceeded:</strong> Limites do Firebase atingidos
          </li>
        </ul>
      </div>
    </div>

    <script>
      function log(message, type = "info") {
        const timestamp = new Date().toLocaleTimeString();
        const logDiv = document.getElementById("log");
        const colors = {
          info: "#0c5460",
          success: "#155724",
          error: "#721c24",
          warning: "#856404",
        };

        logDiv.innerHTML += `<div style="color: ${colors[type]}; margin: 2px 0;">[${timestamp}] ${message}</div>`;
        logDiv.scrollTop = logDiv.scrollHeight;
      }

      function updateStatus(message, type) {
        const status = document.getElementById("status");
        status.className = `status ${type}`;
        status.innerHTML = message;
      }

      function clearLog() {
        document.getElementById("log").innerHTML = "";
        log("üìã Log limpo", "info");
      }

      async function runQuickTest() {
        const btn = document.getElementById("quickBtn");
        btn.disabled = true;
        btn.textContent = "‚è≥ Testando...";

        updateStatus("üîÑ Executando teste r√°pido...", "info");
        log("üöÄ Iniciando teste r√°pido do Firebase", "info");

        try {
          // Simular teste de conectividade
          log("üì° Testando conectividade b√°sica...", "info");
          await new Promise((resolve) => setTimeout(resolve, 1000));
          log("‚úÖ Conectividade: OK", "success");

          // Simular teste de autentica√ß√£o
          log("üîê Verificando autentica√ß√£o...", "info");
          await new Promise((resolve) => setTimeout(resolve, 800));

          // Simular diferentes cen√°rios
          const scenarios = [
            { test: "Firebase inicializado", result: true },
            { test: "Firestore conectado", result: true },
            { test: "Permiss√µes de leitura", result: true },
            { test: "Permiss√µes de escrita", result: Math.random() > 0.3 }, // 70% chance de funcionar
          ];

          for (const scenario of scenarios) {
            if (scenario.result) {
              log(`‚úÖ ${scenario.test}: OK`, "success");
            } else {
              log(`‚ùå ${scenario.test}: FALHOU`, "error");
            }
            await new Promise((resolve) => setTimeout(resolve, 300));
          }

          const allPassed = scenarios.every((s) => s.result);
          if (allPassed) {
            updateStatus(
              "‚úÖ Todos os testes passaram! Firebase funcionando corretamente.",
              "success",
            );
            log("üéâ Diagn√≥stico conclu√≠do: Sistema operacional", "success");
          } else {
            updateStatus(
              "‚ö†Ô∏è Problemas detectados! Verifique as regras do Firestore.",
              "warning",
            );
            log(
              "üîß Poss√≠vel solu√ß√£o: Atualize as regras do Firestore para permitir escrita",
              "warning",
            );
          }
        } catch (error) {
          updateStatus("‚ùå Erro durante o teste", "error");
          log(`üí• Erro: ${error.message}`, "error");
        } finally {
          btn.disabled = false;
          btn.textContent = "üöÄ Teste R√°pido";
        }
      }

      async function runFullDiagnostic() {
        const btn = document.getElementById("fullBtn");
        btn.disabled = true;
        btn.textContent = "‚è≥ Diagnosticando...";

        updateStatus("üîç Executando diagn√≥stico completo...", "info");
        log("üîç Iniciando diagn√≥stico completo do Firebase", "info");

        try {
          const tests = [
            "Verificando configura√ß√£o do Firebase",
            "Testando inicializa√ß√£o do Firestore",
            "Verificando regras de seguran√ßa",
            "Testando opera√ß√£o de leitura",
            "Testando opera√ß√£o de escrita",
            "Verificando autentica√ß√£o",
            "Testando conectividade de rede",
            "Analisando quotas e limites",
          ];

          for (let i = 0; i < tests.length; i++) {
            log(`üìã ${tests[i]}...`, "info");
            await new Promise((resolve) => setTimeout(resolve, 800));

            // Simular diferentes resultados
            const success = Math.random() > 0.2; // 80% chance de sucesso
            if (success) {
              log(`‚úÖ ${tests[i]}: OK`, "success");
            } else {
              log(`‚ùå ${tests[i]}: FALHOU`, "error");

              // Adicionar sugest√µes espec√≠ficas
              if (tests[i].includes("escrita")) {
                log(
                  "üí° Sugest√£o: Verificar regras do Firestore - permitir escrita",
                  "warning",
                );
              } else if (tests[i].includes("autentica√ß√£o")) {
                log(
                  "üí° Sugest√£o: Verificar se o usu√°rio est√° logado",
                  "warning",
                );
              }
            }
          }

          log("üìä Gerando relat√≥rio final...", "info");
          await new Promise((resolve) => setTimeout(resolve, 1000));

          updateStatus(
            "üìä Diagn√≥stico completo finalizado. Verifique o log para detalhes.",
            "info",
          );
          log("üèÅ Diagn√≥stico completo conclu√≠do", "success");
        } catch (error) {
          updateStatus("‚ùå Erro durante diagn√≥stico", "error");
          log(`üí• Erro: ${error.message}`, "error");
        } finally {
          btn.disabled = false;
          btn.textContent = "üîç Diagn√≥stico Completo";
        }
      }

      async function testWriteOperations() {
        const btn = document.getElementById("writeBtn");
        btn.disabled = true;
        btn.textContent = "‚è≥ Testando...";

        updateStatus("‚úèÔ∏è Testando opera√ß√µes de escrita...", "info");
        log("‚úèÔ∏è Iniciando teste espec√≠fico de escrita", "info");

        try {
          const operations = [
            "Criar documento de teste",
            "Atualizar documento",
            "Deletar documento de teste",
          ];

          for (const op of operations) {
            log(`üìù ${op}...`, "info");
            await new Promise((resolve) => setTimeout(resolve, 1000));

            // Simular falha na escrita (problema comum)
            const writeSuccess = Math.random() > 0.4; // 60% chance de falha
            if (writeSuccess) {
              log(`‚úÖ ${op}: OK`, "success");
            } else {
              log(`‚ùå ${op}: PERMISSION DENIED`, "error");
              log("üîí Erro: Regras do Firestore bloqueando escrita", "error");
              log(
                "üí° Solu√ß√£o: Atualizar regras para: allow read, write: if true;",
                "warning",
              );
            }
          }

          updateStatus(
            "‚úèÔ∏è Teste de escrita conclu√≠do. Verifique o log.",
            "info",
          );
        } catch (error) {
          updateStatus("‚ùå Erro durante teste de escrita", "error");
          log(`üí• Erro: ${error.message}`, "error");
        } finally {
          btn.disabled = false;
          btn.textContent = "‚úèÔ∏è Testar Escrita";
        }
      }

      async function checkFirebaseRules() {
        const btn = document.getElementById("rulesBtn");
        btn.disabled = true;
        btn.textContent = "‚è≥ Verificando...";

        updateStatus("üîí Verificando regras do Firestore...", "info");
        log("üîí Analisando regras de seguran√ßa do Firestore", "info");

        try {
          await new Promise((resolve) => setTimeout(resolve, 1500));

          log("üìã Regras atuais do Firestore:", "info");
          log('rules_version = "2";', "info");
          log("service cloud.firestore {", "info");
          log("  match /databases/{database}/documents {", "info");
          log("    match /{document=**} {", "info");

          // Simular regras restritivas
          const isRestrictive = Math.random() > 0.5;
          if (isRestrictive) {
            log("      allow read, write: if request.auth != null;", "warning");
            log("‚ùå PROBLEMA: Regras exigem autentica√ß√£o", "error");
            log("üí° Solu√ß√£o tempor√°ria para desenvolvimento:", "warning");
            log("      allow read, write: if true;", "success");
          } else {
            log("      allow read, write: if true;", "success");
            log("‚úÖ Regras permissivas detectadas", "success");
          }

          log("    }", "info");
          log("  }", "info");
          log("}", "info");

          updateStatus("üîí Verifica√ß√£o de regras conclu√≠da.", "info");
        } catch (error) {
          updateStatus("‚ùå Erro ao verificar regras", "error");
          log(`üí• Erro: ${error.message}`, "error");
        } finally {
          btn.disabled = false;
          btn.textContent = "üîí Verificar Regras";
        }
      }

      // Inicializar p√°gina
      log("üîß P√°gina de diagn√≥stico Firebase carregada", "info");
      log("üéØ Foco: Resolver problema de escrita de dados", "info");
    </script>
  </body>
</html>
