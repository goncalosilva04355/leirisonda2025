<!doctype html>
<html>
  <head>
    <title>Debug Firestore Initialization</title>
    <style>
      body {
        font-family: monospace;
        padding: 20px;
        background: #1a1a1a;
        color: #fff;
      }
      .log {
        margin: 5px 0;
        padding: 10px;
        border-left: 4px solid #ccc;
      }
      .success {
        border-color: #0f0;
        background: #001100;
        color: #0f0;
      }
      .error {
        border-color: #f00;
        background: #110000;
        color: #f00;
      }
      .warning {
        border-color: #ff0;
        background: #111100;
        color: #ff0;
      }
      .info {
        border-color: #0ff;
        background: #001111;
        color: #0ff;
      }
      button {
        background: #007acc;
        color: white;
        border: none;
        padding: 10px 20px;
        cursor: pointer;
        margin: 5px;
      }
    </style>
  </head>
  <body>
    <h1>ğŸ” Debug Firestore Initialization</h1>

    <button onclick="debugStep1()">ğŸ”§ Passo 1: Verificar Firebase App</button>
    <button onclick="debugStep2()">ğŸ”¥ Passo 2: Inicializar Firestore</button>
    <button onclick="debugStep3()">ğŸ“ Passo 3: Testar Escrita</button>
    <button onclick="debugComplete()">ğŸš€ Debug Completo</button>
    <button onclick="clearLogs()">ğŸ—‘ï¸ Limpar</button>

    <div id="logs"></div>

    <script type="module">
      import {
        initializeApp,
        getApps,
        getApp,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import {
        getFirestore,
        collection,
        addDoc,
        serverTimestamp,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

      // ConfiguraÃ§Ã£o exata do projeto
      const firebaseConfig = {
        apiKey: "AIzaSyBM6gvL9L6K0CEnM3s5ZzPGqHzut7idLQw",
        authDomain: "leiria-1cfc9.firebaseapp.com",
        databaseURL:
          "https://leiria-1cfc9-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "leiria-1cfc9",
        storageBucket: "leiria-1cfc9.firebasestorage.app",
        messagingSenderId: "632599887141",
        appId: "1:632599887141:web:1290b471d41fc3ad64eecc",
        measurementId: "G-Q2QWQVH60L",
      };

      let app = null;
      let db = null;

      function log(message, type = "info") {
        const timestamp = new Date().toLocaleTimeString();
        console.log(`[${timestamp}] ${message}`);

        const div = document.createElement("div");
        div.className = `log ${type}`;
        div.textContent = `[${timestamp}] ${message}`;
        document.getElementById("logs").appendChild(div);
        div.scrollIntoView({ behavior: "smooth" });
      }

      window.clearLogs = () => {
        document.getElementById("logs").innerHTML = "";
      };

      window.debugStep1 = async () => {
        log("ğŸ”§ PASSO 1: Verificando Firebase App...", "info");

        try {
          // Verificar se jÃ¡ existe uma app
          const existingApps = getApps();
          log(`ğŸ“‹ Apps existentes: ${existingApps.length}`, "info");

          if (existingApps.length > 0) {
            app = getApp();
            log(`âœ… App existente encontrada: ${app.name}`, "success");
            log(`ğŸ“Š Project ID: ${app.options.projectId}`, "info");
            log(
              `ğŸ”‘ API Key: ${app.options.apiKey ? "Configurada" : "MISSING"}`,
              app.options.apiKey ? "success" : "error",
            );
          } else {
            log("ğŸ†• Nenhuma app existente, criando nova...", "info");
            app = initializeApp(firebaseConfig);
            log(`âœ… Nova app criada: ${app.name}`, "success");
            log(`ğŸ“Š Project ID: ${app.options.projectId}`, "info");
          }

          // Verificar propriedades essenciais
          const required = ["projectId", "apiKey", "authDomain"];
          for (const prop of required) {
            const value = app.options[prop];
            if (value) {
              log(`âœ… ${prop}: ${value}`, "success");
            } else {
              log(`âŒ ${prop}: MISSING`, "error");
            }
          }
        } catch (error) {
          log(`âŒ Erro no Passo 1: ${error.message}`, "error");
          log(`ğŸ” Stack: ${error.stack}`, "error");
        }
      };

      window.debugStep2 = async () => {
        log("ğŸ”¥ PASSO 2: Inicializando Firestore...", "info");

        try {
          if (!app) {
            log(
              "âš ï¸ Firebase App nÃ£o encontrada, executando Passo 1 primeiro...",
              "warning",
            );
            await debugStep1();
          }

          if (!app) {
            log("âŒ NÃ£o Ã© possÃ­vel continuar sem Firebase App", "error");
            return;
          }

          log("ğŸ“ Chamando getFirestore()...", "info");
          db = getFirestore(app);

          if (db) {
            log("âœ… Firestore inicializado com sucesso!", "success");
            log(`ğŸ†” Tipo: ${typeof db}`, "info");
            log(`ğŸ“ App associada: ${db.app.name}`, "info");
            log(`ğŸ—ï¸ Project: ${db.app.options.projectId}`, "info");
          } else {
            log("âŒ getFirestore() retornou null/undefined", "error");
          }
        } catch (error) {
          log(`âŒ Erro no Passo 2: ${error.message}`, "error");
          log(`ğŸ” CÃ³digo: ${error.code || "N/A"}`, "error");

          // DiagnÃ³stico especÃ­fico de erros
          if (error.code === "firestore/unavailable") {
            log(
              "ğŸš« Firestore nÃ£o estÃ¡ habilitado neste projeto Firebase",
              "error",
            );
            log(
              "ğŸ’¡ SoluÃ§Ã£o: VÃ¡ ao Firebase Console > Firestore Database > Criar banco",
              "warning",
            );
          } else if (error.code === "auth/invalid-api-key") {
            log("ğŸ”‘ API Key invÃ¡lida", "error");
            log("ğŸ’¡ SoluÃ§Ã£o: Verificar configuraÃ§Ã£o da API Key", "warning");
          } else if (error.message.includes("network")) {
            log("ğŸŒ Problema de conectividade", "error");
            log("ğŸ’¡ SoluÃ§Ã£o: Verificar conexÃ£o Ã  internet", "warning");
          }

          log(`ğŸ” Stack: ${error.stack}`, "error");
        }
      };

      window.debugStep3 = async () => {
        log("ğŸ“ PASSO 3: Testando Escrita...", "info");

        try {
          if (!db) {
            log(
              "âš ï¸ Firestore nÃ£o inicializada, executando passos anteriores...",
              "warning",
            );
            await debugStep1();
            await debugStep2();
          }

          if (!db) {
            log("âŒ NÃ£o Ã© possÃ­vel testar escrita sem Firestore", "error");
            return;
          }

          log("âœï¸ Tentando escrever documento de teste...", "info");
          const testData = {
            message: "Debug test from HTML",
            timestamp: serverTimestamp(),
            debugStep: 3,
            userAgent: navigator.userAgent,
            url: window.location.href,
          };

          const docRef = await addDoc(collection(db, "debug_tests"), testData);
          log(`âœ… Escrita SUCESSO! ID: ${docRef.id}`, "success");
          log("ğŸ‰ Firestore estÃ¡ 100% funcional!", "success");
        } catch (error) {
          log(`âŒ Erro no Passo 3: ${error.message}`, "error");
          log(`ğŸ” CÃ³digo: ${error.code || "N/A"}`, "error");

          // DiagnÃ³stico de erros de escrita
          if (error.code === "permission-denied") {
            log("ğŸ”’ PermissÃ£o negada - verificar Firestore Rules", "error");
          } else if (error.code === "unavailable") {
            log("ğŸš« ServiÃ§o indisponÃ­vel", "error");
          } else if (error.code === "deadline-exceeded") {
            log("â° Timeout - operaÃ§Ã£o muito lenta", "error");
          }

          log(`ğŸ” Stack: ${error.stack}`, "error");
        }
      };

      window.debugComplete = async () => {
        log("ğŸš€ EXECUTANDO DEBUG COMPLETO...", "info");
        log("", "info");

        await debugStep1();
        log("", "info");
        await debugStep2();
        log("", "info");
        await debugStep3();
        log("", "info");

        if (db) {
          log("ğŸ‰ RESULTADO: Firestore estÃ¡ FUNCIONANDO!", "success");
        } else {
          log("ğŸ’¥ RESULTADO: Firestore NÃƒO estÃ¡ funcionando", "error");

          // Resumo de soluÃ§Ãµes
          log("", "info");
          log("ğŸ”§ POSSÃVEIS SOLUÃ‡Ã•ES:", "warning");
          log(
            "1. Verificar se Firestore estÃ¡ habilitado no Firebase Console",
            "warning",
          );
          log("2. Confirmar API Key e configuraÃ§Ã£o do projeto", "warning");
          log("3. Verificar regras de seguranÃ§a (firestore.rules)", "warning");
          log("4. Testar conectividade com a internet", "warning");
        }
      };

      // Auto-executar
      window.addEventListener("load", () => {
        log("ğŸ” Debug page loaded", "info");
        log("ğŸ“Š ConfiguraÃ§Ã£o do projeto:", "info");
        log(`  - Project ID: ${firebaseConfig.projectId}`, "info");
        log(`  - Auth Domain: ${firebaseConfig.authDomain}`, "info");
        log("", "info");
        log(
          "ğŸ‘† Clique em 'Debug Completo' para executar todos os testes",
          "info",
        );
      });
    </script>
  </body>
</html>
