const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/hybridDataSync-oF9HlDFf.js","assets/index-DSMUUpBF.js","assets/react-vendor-rbdJLrTD.js","assets/vendor-C-G65PT7.js","assets/pdf-vendor-BI33O7zM.js","assets/ui-vendor-Bp3IFwLp.js","assets/index-BiPnNVzT.css"])))=>i.map(i=>d[i]);
var l=Object.defineProperty;var u=(s,e,t)=>e in s?l(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var i=(s,e,t)=>u(s,typeof e!="symbol"?e+"":e,t);import{_ as c}from"./pdf-vendor-BI33O7zM.js";import{a as n}from"./index-DSMUUpBF.js";import"./vendor-C-G65PT7.js";import"./react-vendor-rbdJLrTD.js";import"./ui-vendor-Bp3IFwLp.js";class b{constructor(){i(this,"state",{isFirebaseStable:!1,consecutiveSuccesses:0,consecutiveFailures:0,lastSuccessTime:0,autoSyncEnabled:!1,retryDelay:5e3});i(this,"syncInterval",null);i(this,"stabilityTestInterval",null);this.startStabilityTesting()}startStabilityTesting(){console.log("üß† Iniciando teste de estabilidade Firebase..."),this.stabilityTestInterval=setInterval(()=>{this.testFirebaseStability()},3e5),setTimeout(()=>this.testFirebaseStability(),3e3)}async testFirebaseStability(){if(!navigator.onLine){this.markFirebaseUnstable("Offline");return}try{console.log("üîç Testando estabilidade Firebase..."),await n.forceReinitialize()?this.markFirebaseSuccess():this.markFirebaseFailure("Inicializa√ß√£o falhou")}catch(e){this.markFirebaseFailure(`Erro: ${e}`)}}markFirebaseSuccess(){this.state.consecutiveSuccesses++,this.state.consecutiveFailures=0,this.state.lastSuccessTime=Date.now(),this.state.retryDelay=Math.max(5e3,this.state.retryDelay*.8),this.state.consecutiveSuccesses>=3&&!this.state.isFirebaseStable&&(console.log("‚úÖ Firebase detectado como EST√ÅVEL - habilitando auto-sync"),this.state.isFirebaseStable=!0,this.enableAutoSync()),console.log(`üü¢ Firebase est√°vel: ${this.state.consecutiveSuccesses} sucessos`)}markFirebaseFailure(e){this.state.consecutiveFailures++,this.state.consecutiveSuccesses=0,this.state.retryDelay=Math.min(3e5,this.state.retryDelay*1.5),this.state.consecutiveFailures>=2&&this.state.isFirebaseStable&&(console.log("‚ö†Ô∏è Firebase detectado como INST√ÅVEL - desabilitando auto-sync"),this.state.isFirebaseStable=!1,this.disableAutoSync()),console.log(`üî¥ Firebase inst√°vel: ${e} (${this.state.consecutiveFailures} falhas)`)}enableAutoSync(){this.state.autoSyncEnabled||(console.log("üöÄ HABILITANDO sincroniza√ß√£o autom√°tica!"),this.state.autoSyncEnabled=!0,this.syncInterval=setInterval(()=>{this.performIntelligentSync()},18e4),setTimeout(()=>this.performIntelligentSync(),2e3))}disableAutoSync(){this.state.autoSyncEnabled&&(console.log("‚è∏Ô∏è DESABILITANDO sincroniza√ß√£o autom√°tica (Firebase inst√°vel)"),this.state.autoSyncEnabled=!1,this.syncInterval&&(clearInterval(this.syncInterval),this.syncInterval=null))}async performIntelligentSync(){if(!(!this.state.isFirebaseStable||!navigator.onLine))try{console.log("üîÑ Sincroniza√ß√£o autom√°tica inteligente iniciando...");const{hybridDataSync:e}=await c(async()=>{const{hybridDataSync:a}=await import("./hybridDataSync-oF9HlDFf.js");return{hybridDataSync:a}},__vite__mapDeps([0,1,2,3,4,5,6])),{robustLoginService:t}=await c(async()=>{const{robustLoginService:a}=await import("./index-DSMUUpBF.js").then(o=>o.r);return{robustLoginService:a}},__vite__mapDeps([1,2,3,4,5,6]));if(!t.getCurrentUser()){console.log("‚ÑπÔ∏è Sem utilizador logado - sync cancelado");return}await e.performBackgroundSync(),this.markFirebaseSuccess(),console.log("‚úÖ Sincroniza√ß√£o autom√°tica conclu√≠da")}catch(e){console.warn("‚ö†Ô∏è Erro na sincroniza√ß√£o autom√°tica:",e),this.markFirebaseFailure(`Sync error: ${e}`)}}async forceSyncIfStable(){if(!navigator.onLine)return{success:!1,message:"Sem conex√£o √† internet"};if(!this.state.isFirebaseStable)return{success:!1,message:"Firebase inst√°vel. Aguardando estabiliza√ß√£o..."};try{return await this.performIntelligentSync(),{success:!0,message:"Sincroniza√ß√£o manual conclu√≠da"}}catch{return{success:!1,message:"Erro na sincroniza√ß√£o. Dados seguros localmente."}}}getState(){const e=Date.now(),t=this.state.lastSuccessTime>0?Math.max(0,6e4-(e-this.state.lastSuccessTime)):0;return{...this.state,nextTestIn:t}}async tryActivateFirebase(e,t){try{return console.log("üéØ Tentando ativar Firebase manualmente..."),(await n.signIn(e,t,!0)).success?(this.markFirebaseSuccess(),{success:!0,message:"Firebase ativado! Sincroniza√ß√£o autom√°tica habilitada."}):(await n.signUp(e,t)).success?(this.markFirebaseSuccess(),{success:!0,message:"Conta Firebase criada! Sincroniza√ß√£o autom√°tica habilitada."}):{success:!1,message:"Firebase n√£o conseguiu processar. Sistema local continua funcional."}}catch(r){return this.markFirebaseFailure(`Manual activation failed: ${r}`),{success:!1,message:"Firebase temporariamente indispon√≠vel. Sistema local ativo."}}}destroy(){this.syncInterval&&clearInterval(this.syncInterval),this.stabilityTestInterval&&clearInterval(this.stabilityTestInterval)}}const d=new b;export{d as default,d as intelligentFirebaseSync};
