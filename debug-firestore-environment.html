<!doctype html>
<html>
  <head>
    <title>Debug Firebase Environment - Leirisonda</title>
    <style>
      body {
        font-family: monospace;
        padding: 20px;
        background: #1a1a1a;
        color: #fff;
      }
      .status {
        margin: 10px 0;
        padding: 10px;
        border-left: 4px solid #ccc;
      }
      .success {
        border-color: #0f0;
        background: #001100;
      }
      .error {
        border-color: #f00;
        background: #110000;
      }
      .warning {
        border-color: #ff0;
        background: #111100;
      }
      .info {
        border-color: #0ff;
        background: #001111;
      }
      pre {
        background: #333;
        padding: 10px;
        overflow-x: auto;
      }
      button {
        background: #007acc;
        color: white;
        border: none;
        padding: 10px 20px;
        cursor: pointer;
        margin: 5px;
      }
    </style>
  </head>
  <body>
    <h1>üîç Debug Ambiente Firebase - Leirisonda</h1>

    <button onclick="checkEnvironment()">üîç Verificar Ambiente</button>
    <button onclick="testNetlifyVars()">üåê Testar Vari√°veis Netlify</button>
    <button onclick="forceFirebaseTest()">üî• For√ßar Teste Firebase</button>

    <div id="results"></div>

    <script>
      function log(message, type = 'info') {
          const div = document.createElement('div');
          div.className = `status ${type}`;
          div.innerHTML = message;
          document.getElementById('results').appendChild(div);
      }

      function checkEnvironment() {
          document.getElementById('results').innerHTML = '';

          log("üîç <strong>VERIFICA√á√ÉO DE AMBIENTE</strong>");

          // Verificar se estamos no desenvolvimento
          const isDev = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
          log(`üìç Ambiente: ${isDev ? 'DESENVOLVIMENTO' : 'PRODU√á√ÉO'}`, isDev ? 'warning' : 'success');

          // Verificar URL atual
          log(`üåê URL atual: ${window.location.href}`, 'info');

          // Verificar se h√° vari√°veis de ambiente expostas
          const hasViteVars = typeof import !== 'undefined';
          log(`‚öôÔ∏è Suporte import.meta: ${hasViteVars ? 'SIM' : 'N√ÉO'}`, hasViteVars ? 'success' : 'error');

          // Simular verifica√ß√£o do Firebase
          const firebaseConfig = {
              apiKey: "AIzaSyBM6gvL9L6K0CEnM3s5ZzPGqHzut7idLQw",
              projectId: "leiria-1cfc9",
              authDomain: "leiria-1cfc9.firebaseapp.com"
          };

          log(`üî• Projeto Firebase: <strong>${firebaseConfig.projectId}</strong>`, 'success');
          log(`üîë API Key presente: ${firebaseConfig.apiKey ? 'SIM' : 'N√ÉO'}`, firebaseConfig.apiKey ? 'success' : 'error');
          log(`üè† Auth Domain: ${firebaseConfig.authDomain}`, 'info');

          // Verificar se estamos no Netlify
          const isNetlify = window.location.hostname.includes('netlify') ||
                           window.location.hostname.includes('.app') ||
                           window.location.hostname !== 'localhost';
          log(`üåê Detectado Netlify: ${isNetlify ? 'SIM' : 'N√ÉO'}`, isNetlify ? 'success' : 'warning');

          // Status do localStorage
          try {
              localStorage.setItem('test', 'test');
              localStorage.removeItem('test');
              log("üíæ localStorage: FUNCIONANDO", 'success');
          } catch (e) {
              log("üíæ localStorage: ERRO", 'error');
          }
      }

      function testNetlifyVars() {
          log("üåê <strong>TESTE VARI√ÅVEIS NETLIFY</strong>");

          // Lista de vari√°veis que deveriam existir no Netlify
          const expectedVars = [
              'VITE_FIREBASE_API_KEY',
              'VITE_FIREBASE_AUTH_DOMAIN',
              'VITE_FIREBASE_PROJECT_ID',
              'VITE_FIREBASE_STORAGE_BUCKET',
              'VITE_FIREBASE_MESSAGING_SENDER_ID',
              'VITE_FIREBASE_APP_ID'
          ];

          // Como estamos em HTML puro, simular verifica√ß√£o
          const isNetlifyBuild = window.location.hostname.includes('netlify') ||
                                window.location.hostname.includes('.app');

          if (isNetlifyBuild) {
              log("‚úÖ Ambiente Netlify detectado", 'success');
              log("üìù Vari√°veis VITE_FIREBASE_* devem estar configuradas no Netlify", 'info');
          } else {
              log("‚ö†Ô∏è N√£o est√° no Netlify - usando fallback local", 'warning');
              log("üîß Deploy no Netlify ativar√° as vari√°veis de ambiente", 'info');
          }

          log("üí° <strong>IMPORTANTE:</strong> Firebase s√≥ funciona 100% ap√≥s deploy no Netlify com as vari√°veis configuradas", 'warning');
      }

      async function forceFirebaseTest() {
          log("üî• <strong>TESTE FIREBASE FOR√áADO</strong>");

          try {
              // Importar Firebase
              const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
              const { getFirestore, doc, setDoc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');

              log("‚úÖ Firebase SDK carregado", 'success');

              const firebaseConfig = {
                  apiKey: "AIzaSyBM6gvL9L6K0CEnM3s5ZzPGqHzut7idLQw",
                  authDomain: "leiria-1cfc9.firebaseapp.com",
                  databaseURL: "https://leiria-1cfc9-default-rtdb.europe-west1.firebasedatabase.app",
                  projectId: "leiria-1cfc9",
                  storageBucket: "leiria-1cfc9.firebasestorage.app",
                  messagingSenderId: "632599887141",
                  appId: "1:632599887141:web:1290b471d41fc3ad64eecc"
              };

              const app = initializeApp(firebaseConfig);
              log("‚úÖ Firebase App inicializada", 'success');

              const db = getFirestore(app);
              log("‚úÖ Firestore obtido", 'success');

              // Teste de escrita
              const testId = `debug_test_${Date.now()}`;
              await setDoc(doc(db, "debug_tests", testId), {
                  message: "Teste de debug ambiente",
                  timestamp: serverTimestamp(),
                  userAgent: navigator.userAgent,
                  url: window.location.href,
                  testType: "environment_debug"
              });

              log(`üéâ <strong>SUCESSO!</strong> Documento gravado no Firestore com ID: ${testId}`, 'success');
              log("‚úÖ Firestore est√° FUNCIONANDO PERFEITAMENTE!", 'success');

          } catch (error) {
              log(`‚ùå <strong>ERRO:</strong> ${error.message}`, 'error');
              log(`üîç C√≥digo: ${error.code || 'N/A'}`, 'error');
              log(`üìç Stack: <pre>${error.stack}</pre>`, 'error');

              if (error.code === 'permission-denied') {
                  log("üîí Problema de PERMISS√ïES - verificar Firestore Rules", 'error');
              } else if (error.code === 'unavailable') {
                  log("üö´ Firestore INDISPON√çVEL - servi√ßo desabilitado?", 'error');
              } else {
                  log("‚ùì Erro desconhecido - verificar configura√ß√£o", 'error');
              }
          }
      }

      // Executar verifica√ß√£o autom√°tica
      checkEnvironment();
    </script>
  </body>
</html>
