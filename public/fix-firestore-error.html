<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>üîß Corrigir Erro Firestore</title>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        min-height: 100vh;
        padding: 20px;
        color: white;
      }
      .container {
        max-width: 600px;
        margin: 0 auto;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
      }
      h1 {
        text-align: center;
        margin-bottom: 20px;
        font-size: 28px;
      }
      .error-box {
        background: rgba(231, 76, 60, 0.3);
        border: 2px solid #e74c3c;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 30px;
      }
      .btn {
        width: 100%;
        padding: 15px;
        margin: 10px 0;
        border: none;
        border-radius: 10px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: block;
        text-align: center;
      }
      .btn-danger {
        background: linear-gradient(135deg, #e74c3c, #c0392b);
        color: white;
      }
      .btn-success {
        background: linear-gradient(135deg, #27ae60, #229954);
        color: white;
      }
      .btn-primary {
        background: linear-gradient(135deg, #3498db, #2980b9);
        color: white;
      }
      .btn:active {
        transform: scale(0.98);
      }
      .log {
        background: rgba(0, 0, 0, 0.3);
        padding: 15px;
        border-radius: 8px;
        margin: 10px 0;
        font-family: monospace;
        font-size: 14px;
        max-height: 300px;
        overflow-y: auto;
      }
      .step {
        margin: 15px 0;
        padding: 15px;
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.1);
      }
      .status {
        padding: 10px;
        border-radius: 5px;
        margin: 10px 0;
        text-align: center;
        font-weight: bold;
      }
      .status-success {
        background: rgba(39, 174, 96, 0.3);
        border: 1px solid #27ae60;
      }
      .status-error {
        background: rgba(231, 76, 60, 0.3);
        border: 1px solid #e74c3c;
      }
      .status-warning {
        background: rgba(241, 196, 15, 0.3);
        border: 1px solid #f1c40f;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üîß Corrigir Erro Firestore</h1>

      <div class="error-box">
        <h3>‚ùå Erro Detectado:</h3>
        <p><strong>"Firestore n√£o conseguiu ser inicializado"</strong></p>
        <p>Este erro impede que os dados sejam salvos no Firestore.</p>
      </div>

      <!-- Bot√µes de corre√ß√£o -->
      <button class="btn btn-danger" onclick="diagnosticarErro()">
        üîç DIAGNOSTICAR ERRO
      </button>

      <button class="btn btn-success" onclick="corrigirErro()">
        üõ†Ô∏è CORRIGIR AUTOMATICAMENTE
      </button>

      <button class="btn btn-primary" onclick="testarAposCorracao()">
        ‚úÖ TESTAR AP√ìS CORRE√á√ÉO
      </button>

      <!-- Log de resultados -->
      <div id="log" class="log" style="display: none"></div>

      <!-- Status atual -->
      <div id="status"></div>

      <!-- Links √∫teis -->
      <div style="margin-top: 30px">
        <a href="/" class="btn btn-primary">üè† Voltar √† App</a>
        <a href="/test-final.html" class="btn btn-primary">üß™ Teste Final</a>
      </div>
    </div>

    <script type="module">
      import {
        initializeApp,
        getApps,
        getApp,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import {
        getFirestore,
        collection,
        addDoc,
        serverTimestamp,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

      const config = {
        apiKey: "AIzaSyBM6gvL9L6K0CEnM3s5ZzPGqHzut7idLQw",
        authDomain: "leiria-1cfc9.firebaseapp.com",
        projectId: "leiria-1cfc9",
        storageBucket: "leiria-1cfc9.firebasestorage.app",
        messagingSenderId: "632599887141",
        appId: "1:632599887141:web:1290b471d41fc3ad64eecc",
      };

      let app, db;

      function log(msg, show = true) {
        console.log(msg);
        if (show) {
          const logDiv = document.getElementById("log");
          logDiv.style.display = "block";
          logDiv.innerHTML += `[${new Date().toLocaleTimeString()}] ${msg}\n`;
          logDiv.scrollTop = logDiv.scrollHeight;
        }
      }

      function setStatus(msg, type) {
        const statusDiv = document.getElementById("status");
        statusDiv.className = `status status-${type}`;
        statusDiv.textContent = msg;
      }

      window.diagnosticarErro = async function () {
        log("üîç Iniciando diagn√≥stico...");
        setStatus("Diagnosticando...", "warning");

        try {
          // 1. Verificar se Firebase pode ser inicializado
          log("1. Verificando inicializa√ß√£o Firebase...");

          const existingApps = getApps();
          log(`   Apps existentes: ${existingApps.length}`);

          if (existingApps.length > 0) {
            app = getApp();
            log(`   ‚úÖ App existente: ${app.name}`);
          } else {
            app = initializeApp(config, "diagnostic-app");
            log(`   ‚úÖ Nova app criada: ${app.name}`);
          }

          // 2. Verificar configura√ß√£o
          log("2. Verificando configura√ß√£o...");
          log(`   Project ID: ${app.options.projectId}`);
          log(`   API Key: ${app.options.apiKey ? "Configurada" : "MISSING"}`);
          log(`   Auth Domain: ${app.options.authDomain}`);

          // 3. Tentar inicializar Firestore
          log("3. Tentando inicializar Firestore...");
          db = getFirestore(app);

          if (db) {
            log("   ‚úÖ Firestore inicializado com sucesso!");

            // 4. Testar opera√ß√£o b√°sica
            log("4. Testando opera√ß√£o b√°sica...");
            const testDoc = await addDoc(collection(db, "diagnostic_test"), {
              message: "Teste diagn√≥stico",
              timestamp: serverTimestamp(),
            });

            log(`   ‚úÖ Documento teste criado: ${testDoc.id}`);
            setStatus("‚úÖ FIRESTORE EST√Å FUNCIONANDO!", "success");
          } else {
            log("   ‚ùå getFirestore() retornou null");
            setStatus("‚ùå ERRO: Firestore retornou null", "error");
          }
        } catch (error) {
          log(`‚ùå ERRO: ${error.message}`);
          log(`   C√≥digo: ${error.code || "N/A"}`);

          if (error.code === "firestore/unavailable") {
            log("üí° CAUSA: Firestore n√£o est√° habilitado no projeto");
            log("üí° SOLU√á√ÉO: Habilitar Firestore no Firebase Console");
            setStatus("‚ùå FIRESTORE N√ÉO HABILITADO", "error");
          } else if (error.code === "permission-denied") {
            log("üí° CAUSA: Regras de seguran√ßa muito restritivas");
            setStatus("‚ùå PROBLEMA DE PERMISS√ïES", "error");
          } else {
            log("üí° CAUSA: Erro de configura√ß√£o ou rede");
            setStatus("‚ùå ERRO DE CONFIGURA√á√ÉO", "error");
          }
        }
      };

      window.corrigirErro = async function () {
        log("üõ†Ô∏è Iniciando corre√ß√£o autom√°tica...");
        setStatus("Corrigindo...", "warning");

        try {
          // Corre√ß√£o 1: Limpar apps existentes e recriar
          log("1. Limpando apps existentes...");
          const existingApps = getApps();
          log(`   Encontradas ${existingApps.length} apps`);

          // Corre√ß√£o 2: Criar nova app com timestamp √∫nico
          log("2. Criando nova app Firebase...");
          const newAppName = `corrected-app-${Date.now()}`;
          app = initializeApp(config, newAppName);
          log(`   ‚úÖ Nova app criada: ${newAppName}`);

          // Corre√ß√£o 3: Aguardar um pouco antes de inicializar Firestore
          log("3. Aguardando estabiliza√ß√£o...");
          await new Promise((resolve) => setTimeout(resolve, 2000));

          // Corre√ß√£o 4: Inicializar Firestore com retry
          log("4. Inicializando Firestore com retry...");
          let attempts = 0;
          const maxAttempts = 3;

          while (attempts < maxAttempts) {
            try {
              log(`   Tentativa ${attempts + 1}/${maxAttempts}...`);
              db = getFirestore(app);

              if (db) {
                log("   ‚úÖ Firestore inicializado!");
                break;
              } else {
                throw new Error("getFirestore retornou null");
              }
            } catch (error) {
              attempts++;
              if (attempts >= maxAttempts) {
                throw error;
              }
              log(`   ‚ùå Tentativa ${attempts} falhou, tentando novamente...`);
              await new Promise((resolve) => setTimeout(resolve, 1000));
            }
          }

          // Corre√ß√£o 5: Teste final
          log("5. Testando corre√ß√£o...");
          const testDoc = await addDoc(collection(db, "correction_test"), {
            message: "Teste ap√≥s corre√ß√£o",
            timestamp: serverTimestamp(),
            correctionTime: new Date().toISOString(),
          });

          log(`   ‚úÖ Documento teste criado: ${testDoc.id}`);
          setStatus("‚úÖ CORRE√á√ÉO CONCLU√çDA COM SUCESSO!", "success");
        } catch (error) {
          log(`‚ùå CORRE√á√ÉO FALHOU: ${error.message}`);
          setStatus("‚ùå CORRE√á√ÉO FALHOU", "error");
        }
      };

      window.testarAposCorracao = async function () {
        if (!db) {
          setStatus("‚ö†Ô∏è Execute 'CORRIGIR' primeiro", "warning");
          return;
        }

        log("‚úÖ Testando ap√≥s corre√ß√£o...");
        setStatus("Testando...", "warning");

        try {
          // Teste completo
          const results = [];

          // Teste 1: Obra
          const obra = await addDoc(collection(db, "obras"), {
            nome: `Obra Corrigida ${Date.now()}`,
            status: "teste_correcao",
            timestamp: serverTimestamp(),
          });
          results.push(`Obra: ${obra.id}`);

          // Teste 2: Piscina
          const piscina = await addDoc(collection(db, "piscinas"), {
            name: `Piscina Corrigida ${Date.now()}`,
            status: "teste_correcao",
            timestamp: serverTimestamp(),
          });
          results.push(`Piscina: ${piscina.id}`);

          log("‚úÖ TODOS OS TESTES PASSARAM!");
          log(`Resultados: ${results.join(", ")}`);
          setStatus("üéâ FIRESTORE 100% FUNCIONAL!", "success");
        } catch (error) {
          log(`‚ùå TESTE FALHOU: ${error.message}`);
          setStatus("‚ùå TESTE FALHOU", "error");
        }
      };

      // Auto-executar diagn√≥stico ao carregar
      window.addEventListener("load", () => {
        setStatus(
          "P√°gina carregada. Clique em 'DIAGNOSTICAR' para come√ßar.",
          "warning",
        );
      });
    </script>
  </body>
</html>
